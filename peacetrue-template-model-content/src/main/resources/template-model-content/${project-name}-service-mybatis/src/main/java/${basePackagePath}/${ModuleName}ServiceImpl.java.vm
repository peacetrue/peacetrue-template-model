package ${basePackageName};

import com.github.pagehelper.PageHelper;
import com.github.peacetrue.core.Range;
import com.github.peacetrue.mybatis.dynamic.MybatisDynamicUtils;
import com.github.peacetrue.pagehelper.PageHelperUtils;
import com.github.peacetrue.spring.util.BeanUtils;
import com.github.peacetrue.util.EntityNotFoundException;
import org.mybatis.dynamic.sql.SqlBuilder;
import org.mybatis.dynamic.sql.SqlColumn;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.PayloadApplicationEvent;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Service;

import javax.annotation.Nullable;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import static ${basePackageName}.${ModuleName}DynamicSqlSupport.*;

/**
 * @author xiayx
 */
@Service
public class ${ModuleName}ServiceImpl implements ${ModuleName}Service {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private ${ModuleName}Mapper ${uc.lc(${ModuleName})}Mapper;
    @Autowired
    private ApplicationEventPublisher eventPublisher;

    @Override
    public ${ModuleName}VO add(${ModuleName}Add params) {
        logger.info("新增信息[{}]", params);
        ${ModuleName} ${uc.lc(${ModuleName})} =new ${ModuleName}();
        BeanUtils.copyProperties(params, ${uc.lc(${ModuleName})});
        ${uc.lc(${ModuleName})}.setCreatorId(params.getOperatorId());
        ${uc.lc(${ModuleName})}.setCreatedTime(new Date());
        ${uc.lc(${ModuleName})}.setModifierId(params.getOperatorId());
        ${uc.lc(${ModuleName})}.setModifiedTime(${uc.lc(${ModuleName})}.getCreatedTime());
        logger.debug("保存信息[{}]", ${uc.lc(${ModuleName})});
        int count = ${uc.lc(${ModuleName})}Mapper.insertSelective(${uc.lc(${ModuleName})});
        logger.debug("共影响[{}]条记录", count);
        ${ModuleName}VO vo = BeanUtils.map(${uc.lc(${ModuleName})}, ${ModuleName}VO.class);
        eventPublisher.publishEvent(new PayloadApplicationEvent<>(vo, params));
        return vo;
    }

    @Override
    public Page<${ModuleName}VO> query(@Nullable ${ModuleName}Query params, @Nullable Pageable pageable, String... projection) {
        logger.info("分页查询信息[{}]", params);
        if (params == null) params = ${ModuleName}Query.DEFAULT;
        #foreach($property in $properties)
            #if($property.type.simpleName == 'Date')
                if (params.get${lc.uc($property.name)}() == null) params.set${lc.uc($property.name)}(new Range.Date());
            #end
        #end
        if (pageable == null) pageable = PageRequest.of(0, 10, Sort.by(Sort.Direction.DESC, "createdTime"));
        PageHelper.startPage(pageable.getPageNumber() + 1, pageable.getPageSize());
        List<${ModuleName}> entities = ${uc.lc(${ModuleName})}Mapper.selectByExample()
                .where()
        .and(id, MybatisDynamicUtils.getConditionWhenPresent(params.getIds(), SqlBuilder::isIn))
            #foreach($property in $properties)
                #if($property.type.simpleName == 'String')
                .and($property.name, SqlBuilder.isLikeWhenPresent(MybatisDynamicUtils.likeValue(params.get${lc.uc($property.name)}())))
                #elseif($property.type.simpleName == 'Integer'||$property.type.simpleName == 'Long')
                .and($property.name, SqlBuilder.isEqualToWhenPresent(params.get${lc.uc($property.name)}()))
                #elseif($property.type.simpleName == 'Date')
                        .and($property.name, SqlBuilder.isGreaterThanOrEqualToWhenPresent(params.get${lc.uc($property.name)}().getLowerBound()))
                .and($property.name, SqlBuilder.isLessThanWhenPresent(MybatisDynamicUtils.endDateValue(params.get${lc.uc($property.name)}().getUpperBound())))
                #end
            #end
                .orderBy(MybatisDynamicUtils.orders(${uc.lc(${ModuleName})}, pageable.getSort()))
                .build().execute();
        logger.debug("共取得'{}'条记录", entities.size());
        if (entities.isEmpty()) return new PageImpl<>(Collections.emptyList());

        List<${ModuleName}VO> vos = entities.stream()
                .map(${uc.lc(${ModuleName})}->BeanUtils.map(${uc.lc(${ModuleName})}, ${ModuleName}VO.class))
                .collect(Collectors.toList());
        return new PageImpl<>(vos, pageable, PageHelperUtils.getTotal(entities));
    }

    @Override
    public List<${ModuleName}VO> query(${ModuleName}Query params, String... projection) {
        return this.query(params, PageRequest.of(0, Integer.MAX_VALUE), projection).getContent();
    }

    @Override
    public  ${ModuleName}VO get(${ModuleName}Get params, String... projection) {
        logger.info("获取符合条件[{}]的信息", params);
        return this.getOptional(params)
                .orElseThrow(() -> new EntityNotFoundException(${ModuleName}.class,"id", params.getId()));
    }

    protected Optional<${ModuleName}VO> getOptional(${ModuleName}Get params) {
        return ${uc.lc(${ModuleName})}Mapper.selectByExample()
                .where(id, SqlBuilder.isEqualTo(params.getId()))
                .build().execute().stream()
                .reduce((l, r) -> r)
                .map(${uc.lc(${ModuleName})}->BeanUtils.map(${uc.lc(${ModuleName})}, ${ModuleName}VO.class));
    }


    @Override
    public int modify(${ModuleName}Modify params) {
        logger.info("修改信息[{}]", params);
        ${ModuleName}VO vo = this.get(BeanUtils.map(params, ${ModuleName}Get.class));
        ${ModuleName} ${uc.lc(${ModuleName})} =new ${ModuleName}();
        BeanUtils.copyProperties(params, ${uc.lc(${ModuleName})});
        ${uc.lc(${ModuleName})}.setModifierId(params.getOperatorId());
        ${uc.lc(${ModuleName})}.setModifiedTime(new Date());
        int count = ${uc.lc(${ModuleName})}Mapper.updateByPrimaryKeySelective(${uc.lc(${ModuleName})});
        logger.debug("共影响[{}]条记录", count);
        eventPublisher.publishEvent(new PayloadApplicationEvent<>(vo, params));
        return count;
    }

    @Override
    public int delete(${ModuleName}Delete params) {
        logger.info("删除信息[{}]", params);
        ${ModuleName}VO vo = this.get(BeanUtils.map(params, ${ModuleName}Get.class));
        int count = ${uc.lc(${ModuleName})}Mapper.deleteByPrimaryKey(params.getId());
        logger.debug("共影响[{}]条记录", count);
        eventPublisher.publishEvent(new PayloadApplicationEvent<>(vo, params));
        return count;
    }
}
